machine:
  node:
    version: 6
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: conf/key-file.json
    GCLOUD_PROJECT: matchmyroute-backend
    CLOUDSDK_CORE_PROJECT: matchmyroute-backend
    DATASTORE_PROJECT_ID: matchmyroute-backend
    DOCURL: https://matchmyroute-backend.appspot.com
    DB_CONNECTION_PATH: 127.0.0.1
    PGPASSWORD: aUZw[:Gw38H&>Jf2hUwd
    PGPORT: 3306
    STATIC_DIR: build/static

dependencies:
  cache_directories:
    - "/home/ubuntu/.config/gcloud"
    - "/opt/circleci/nodejs/"
  post:
    - npm run clean

test:
  post:
    - mkdir -p temp
    - tar -cvzf temp/build.tgz build
    - cp -a temp/build.tgz $CIRCLE_ARTIFACTS/

deployment:
  production:
    branch: master
    commands:
      - sudo /opt/google-cloud-sdk/bin/gcloud components update -q
#     - sudo /opt/google-cloud-sdk/bin/gcloud components install beta -q
      - sudo chown ubuntu.ubuntu -R /home/ubuntu/.config/gcloud
      - gcloud auth activate-service-account --key-file conf/key-file.json
      - wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64
      - mv cloud_sql_proxy.linux.amd64 cloud_sql_proxy
      - chmod +x cloud_sql_proxy
      - gcloud config set project matchmyroute-backend
      - ./cloud_sql_proxy -instances=matchmyroute-backend:us-east1:matchmyroute-database=tcp:3306 -credential_file=conf/key-file.json
      - npm run deploy
      - URL=https://matchmyroute-backend.appspot.com npm run e2etest
